<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FocusHub - Premium Virtual Coworking Space</title>
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #3f37c9;
      --success: #4cc9f0;
      --danger: #f72585;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --light-gray: #e9ecef;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
    }
    
    body {
      background-color: #f5f7ff;
      color: var(--dark);
      line-height: 1.6;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px 0;
    }
    
    h1 {
      color: var(--primary);
      font-size: 2.5rem;
      margin-bottom: 10px;
    }
    
    .tagline {
      color: var(--gray);
      font-size: 1.1rem;
    }
    
    /* Lobby Styles */
    .lobby-container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    
    .lobby-title {
      font-size: 1.8rem;
      color: var(--primary);
      margin-bottom: 20px;
      text-align: center;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--dark);
    }
    
    input, select, textarea {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--light-gray);
      border-radius: 8px;
      font-size: 1rem;
      transition: border 0.3s ease;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }
    
    .btn {
      display: inline-block;
      padding: 12px 24px;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }
    
    .btn:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }
    
    .btn-block {
      display: block;
      width: 100%;
    }
    
    .btn-outline {
      background-color: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }
    
    .btn-outline:hover {
      background-color: rgba(67, 97, 238, 0.1);
    }
    
    .btn-danger {
      background-color: var(--danger);
    }
    
    .btn-danger:hover {
      background-color: #e5177b;
    }
    
    .btn-group {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }
    
    /* Room Layout */
    .room-container {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 20px;
    }
    
    @media (max-width: 992px) {
      .room-container {
        grid-template-columns: 1fr;
      }
    }
    
    /* Sidebar */
    .sidebar {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-direction: column;
      height: calc(100vh - 140px);
      overflow-y: auto;
    }
    
    .user-card {
      display: flex;
      align-items: center;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      background: rgba(67, 97, 238, 0.05);
    }
    
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      font-weight: 600;
    }
    
    .user-info {
      flex: 1;
    }
    
    .user-name {
      font-weight: 600;
      margin-bottom: 2px;
    }
    
    .user-status {
      font-size: 0.8rem;
      color: var(--gray);
    }
    
    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin: 20px 0 12px;
      color: var(--primary);
      display: flex;
      align-items: center;
    }
    
    .section-title svg {
      margin-right: 8px;
    }
    
    .timer-display {
      font-size: 2rem;
      font-family: monospace;
      text-align: center;
      margin: 15px 0;
      color: var(--dark);
    }
    
    .timer-controls {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .timer-btn {
      padding: 8px;
      font-size: 0.9rem;
    }
    
    /* Main Content */
    .main-content {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    
    video {
      width: 100%;
      border-radius: 8px;
      background: var(--light-gray);
      aspect-ratio: 16/9;
      transition: all 0.3s ease;
    }
    
    video:hover {
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }
    
    /* Chat */
    .chat-container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 300px;
      max-height: 400px;
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 15px;
      padding-right: 10px;
    }
    
    .message {
      margin-bottom: 12px;
      padding: 10px 15px;
      border-radius: 8px;
      background: var(--light);
      max-width: 80%;
    }
    
    .message-sender {
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 4px;
    }
    
    .message-text {
      word-wrap: break-word;
    }
    
    .message-time {
      font-size: 0.75rem;
      color: var(--gray);
      text-align: right;
      margin-top: 4px;
    }
    
    .chat-input-container {
      display: flex;
      gap: 10px;
    }
    
    /* Productivity */
    .productivity-container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    
    .productivity-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-top: 15px;
    }
    
    .stat-card {
      background: var(--light);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: var(--gray);
    }
    
    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .modal.active {
      opacity: 1;
      pointer-events: all;
    }
    
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }
    
    .modal.active .modal-content {
      transform: translateY(0);
    }
    
    .modal-header {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--primary);
    }
    
    /* Utilities */
    .hidden {
      display: none !important;
    }
    
    .text-center {
      text-align: center;
    }
    
    .mt-3 {
      margin-top: 15px;
    }
    
    .mb-3 {
      margin-bottom: 15px;
    }
    
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease forwards;
    }
    
    /* Notification */
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--primary);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
    }
    
    .notification.show {
      transform: translateY(0);
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="fade-in">
      <h1>FocusHub</h1>
      <p class="tagline">Your premium virtual coworking space</p>
    </header>

    <!-- Lobby Screen -->
    <div id="lobby" class="lobby-container fade-in">
      <h2 class="lobby-title">Get Started</h2>
      
      <div class="form-group">
        <label for="userName">Your Name</label>
        <input type="text" id="userName" placeholder="Enter your name">
      </div>
      
      <div class="form-group">
        <label for="focusGoal">Today's Focus Goal</label>
        <input type="text" id="focusGoal" placeholder="What are you working on?">
      </div>
      
      <div class="form-group">
        <label for="userSkills">Your Skills (comma separated)</label>
        <input type="text" id="userSkills" placeholder="e.g. design, coding, writing">
      </div>
      
      <div class="form-group">
        <label for="workType">Work Type</label>
        <select id="workType">
          <option value="">Select your work type</option>
          <option value="coding">Coding/Development</option>
          <option value="design">Design/Creative</option>
          <option value="writing">Writing/Content</option>
          <option value="business">Business/Admin</option>
          <option value="studying">Studying/Learning</option>
        </select>
      </div>
      
      <div class="btn-group">
        <button id="createRoomBtn" class="btn btn-block">Create New Room</button>
        <button id="joinRoomBtn" class="btn btn-block btn-outline">Join Existing Room</button>
      </div>
    </div>

    <!-- Room Screen -->
    <div id="room" class="hidden">
      <div class="room-container">
        <!-- Sidebar -->
        <div class="sidebar">
          <div class="user-card">
            <div class="avatar" id="userAvatar">Y</div>
            <div class="user-info">
              <div class="user-name" id="displayUserName">You</div>
              <div class="user-status">Room: <span id="displayRoomId"></span></div>
            </div>
          </div>
          
          <div class="section-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            Participants (<span id="participantCount">1</span>)
          </div>
          <div id="participantsList">
            <!-- Participants will be added here -->
          </div>
          
          <div class="section-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            Focus Timer
          </div>
          <div class="timer-display" id="timerDisplay">25:00</div>
          <div class="timer-controls">
            <button class="btn timer-btn" data-minutes="15">15m</button>
            <button class="btn timer-btn" data-minutes="25">25m</button>
            <button class="btn timer-btn" data-minutes="50">50m</button>
          </div>
          <button id="timerToggle" class="btn btn-block">Start Timer</button>
          
          <div class="section-title mt-3">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
              <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
            Ambient Sound
          </div>
          <select id="ambientSound" class="mb-3">
            <option value="">None</option>
            <option value="cafe">Coffee Shop</option>
            <option value="rain">Rain</option>
            <option value="fireplace">Fireplace</option>
            <option value="forest">Forest</option>
            <option value="waves">Ocean Waves</option>
          </select>
          
          <div class="section-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
            </svg>
            Productivity
          </div>
          <canvas id="productivityChart" height="200"></canvas>
          
          <div class="productivity-stats">
            <div class="stat-card">
              <div class="stat-value" id="focusedTime">0</div>
              <div class="stat-label">Focused (min)</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="sessionsCount">0</div>
              <div class="stat-label">Sessions</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="streakDays">0</div>
              <div class="stat-label">Day Streak</div>
            </div>
          </div>
          
          <button id="leaveRoomBtn" class="btn btn-danger btn-block mt-3">Leave Room</button>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
          <div class="video-grid" id="videoGrid">
            <video id="userVideo" muted autoplay playsinline></video>
          </div>
          
          <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
              <div class="message">
                <div class="message-sender">FocusHub</div>
                <div class="message-text">Welcome to your coworking space! Start collaborating with your peers.</div>
                <div class="message-time">Just now</div>
              </div>
            </div>
            <div class="chat-input-container">
              <input type="text" id="chatInput" placeholder="Type a message...">
              <button id="sendMessageBtn" class="btn">Send</button>
            </div>
          </div>
          
          <div class="productivity-container">
            <h3 class="section-title">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="20" x2="12" y2="10"></line>
                <line x1="18" y1="20" x2="18" y2="4"></line>
                <line x1="6" y1="20" x2="6" y2="16"></line>
              </svg>
              Weekly Progress
            </h3>
            <canvas id="weeklyChart" height="300"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Join Room Modal -->
    <div id="joinModal" class="modal">
      <div class="modal-content">
        <h3 class="modal-header">Join Room</h3>
        <p>Enter the room ID shared with you:</p>
        <input type="text" id="roomIdInput" class="mb-3" placeholder="e.g. room-abc123">
        <div class="btn-group">
          <button id="cancelJoinBtn" class="btn btn-danger">Cancel</button>
          <button id="confirmJoinBtn" class="btn">Join Room</button>
        </div>
      </div>
    </div>

    <!-- Invite Modal -->
    <div id="inviteModal" class="modal">
      <div class="modal-content">
        <h3 class="modal-header">Invite Others</h3>
        <p>Share this room ID with others:</p>
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
          <input type="text" id="roomIdToShare" readonly style="flex: 1;">
          <button id="copyRoomIdBtn" class="btn">Copy</button>
        </div>
        <p>Or share this link:</p>
        <div style="display: flex; gap: 10px;">
          <input type="text" id="roomLinkToShare" readonly style="flex: 1;">
          <button id="copyLinkBtn" class="btn">Copy</button>
        </div>
        <button id="closeInviteModal" class="btn btn-block mt-3">Close</button>
      </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification">Copied to clipboard!</div>
  </div>

  <audio id="ambientAudio" loop></audio>
  <audio id="timerSound"></audio>

  <script>
    // App State
    const state = {
      user: {
        id: localStorage.getItem('peerId') || `user-${Math.random().toString(36).substr(2, 9)}`,
        name: localStorage.getItem('userName') || '',
        focusGoal: localStorage.getItem('focusGoal') || '',
        skills: localStorage.getItem('skills') ? localStorage.getItem('skills').split(',') : [],
        workType: localStorage.getItem('workType') || ''
      },
      roomId: '',
      peers: [],
      messages: [],
      timer: {
        timeLeft: 1500, // 25 minutes in seconds
        isRunning: false,
        interval: null,
        initialTime: 1500
      },
      ambientSound: '',
      productivity: {
        focusedTime: parseInt(localStorage.getItem('focusedTime')) || 0,
        sessions: JSON.parse(localStorage.getItem('sessions')) || [],
        streak: parseInt(localStorage.getItem('streak')) || 0,
        lastSessionDate: localStorage.getItem('lastSessionDate') || ''
      }
    };

    // DOM Elements
    const elements = {
      lobby: document.getElementById('lobby'),
      room: document.getElementById('room'),
      joinModal: document.getElementById('joinModal'),
      inviteModal: document.getElementById('inviteModal'),
      notification: document.getElementById('notification'),
      
      // Lobby
      userName: document.getElementById('userName'),
      focusGoal: document.getElementById('focusGoal'),
      userSkills: document.getElementById('userSkills'),
      workType: document.getElementById('workType'),
      createRoomBtn: document.getElementById('createRoomBtn'),
      joinRoomBtn: document.getElementById('joinRoomBtn'),
      
      // Room
      userVideo: document.getElementById('userVideo'),
      videoGrid: document.getElementById('videoGrid'),
      displayUserName: document.getElementById('displayUserName'),
      displayRoomId: document.getElementById('displayRoomId'),
      userAvatar: document.getElementById('userAvatar'),
      participantsList: document.getElementById('participantsList'),
      participantCount: document.getElementById('participantCount'),
      timerDisplay: document.getElementById('timerDisplay'),
      timerToggle: document.getElementById('timerToggle'),
      chatMessages: document.getElementById('chatMessages'),
      chatInput: document.getElementById('chatInput'),
      sendMessageBtn: document.getElementById('sendMessageBtn'),
      ambientSound: document.getElementById('ambientSound'),
      ambientAudio: document.getElementById('ambientAudio'),
      timerSound: document.getElementById('timerSound'),
      leaveRoomBtn: document.getElementById('leaveRoomBtn'),
      productivityChart: document.getElementById('productivityChart'),
      weeklyChart: document.getElementById('weeklyChart'),
      focusedTime: document.getElementById('focusedTime'),
      sessionsCount: document.getElementById('sessionsCount'),
      streakDays: document.getElementById('streakDays'),
      
      // Modals
      roomIdInput: document.getElementById('roomIdInput'),
      cancelJoinBtn: document.getElementById('cancelJoinBtn'),
      confirmJoinBtn: document.getElementById('confirmJoinBtn'),
      roomIdToShare: document.getElementById('roomIdToShare'),
      roomLinkToShare: document.getElementById('roomLinkToShare'),
      copyRoomIdBtn: document.getElementById('copyRoomIdBtn'),
      copyLinkBtn: document.getElementById('copyLinkBtn'),
      closeInviteModal: document.getElementById('closeInviteModal')
    };

    // PeerJS instance
    let peer = null;
    let connections = [];
    let productivityChart = null;
    let weeklyChart = null;

    // Initialize the app
    function init() {
      loadUserData();
      setupEventListeners();
      checkStreak();
      
      // Check if we're joining a room from URL
      const urlParams = new URLSearchParams(window.location.search);
      const roomId = urlParams.get('room');
      
      if (roomId) {
        showJoinModal();
        elements.roomIdInput.value = roomId;
      }
    }

    function loadUserData() {
      if (localStorage.getItem('userName')) {
        elements.userName.value = localStorage.getItem('userName');
      }
      if (localStorage.getItem('focusGoal')) {
        elements.focusGoal.value = localStorage.getItem('focusGoal');
      }
      if (localStorage.getItem('skills')) {
        elements.userSkills.value = localStorage.getItem('skills');
      }
      if (localStorage.getItem('workType')) {
        elements.workType.value = localStorage.getItem('workType');
      }
      
      // Update productivity stats
      updateProductivityStats();
    }

    function setupEventListeners() {
      // Lobby
      elements.createRoomBtn.addEventListener('click', createRoom);
      elements.joinRoomBtn.addEventListener('click', showJoinModal);
      
      // Room
      elements.timerToggle.addEventListener('click', toggleTimer);
      elements.sendMessageBtn.addEventListener('click', sendMessage);
      elements.chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
      });
      elements.ambientSound.addEventListener('change', changeAmbientSound);
      elements.leaveRoomBtn.addEventListener('click', leaveRoom);
      
      // Timer buttons
      document.querySelectorAll('.timer-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const minutes = parseInt(btn.dataset.minutes);
          setTimer(minutes * 60);
        });
      });
      
      // Join Modal
      elements.cancelJoinBtn.addEventListener('click', hideJoinModal);
      elements.confirmJoinBtn.addEventListener('click', joinRoom);
      
      // Invite Modal
      elements.copyRoomIdBtn.addEventListener('click', copyRoomId);
      elements.copyLinkBtn.addEventListener('click', copyRoomLink);
      elements.closeInviteModal.addEventListener('click', hideInviteModal);
    }

    function createRoom() {
      // Save user data
      state.user.name = elements.userName.value.trim() || 'Anonymous';
      state.user.focusGoal = elements.focusGoal.value.trim();
      state.user.skills = elements.userSkills.value.split(',').map(s => s.trim());
      state.user.workType = elements.workType.value;
      
      localStorage.setItem('userName', state.user.name);
      localStorage.setItem('focusGoal', state.user.focusGoal);
      localStorage.setItem('skills', state.user.skills.join(','));
      localStorage.setItem('workType', state.user.workType);
      localStorage.setItem('peerId', state.user.id);
      
      // Create room ID
      state.roomId = `room-${Math.random().toString(36).substr(2, 6)}`;
      
      // Initialize PeerJS
      initializePeer();
      
      // Update UI
      updateUserDisplay();
      elements.lobby.classList.add('hidden');
      elements.room.classList.remove('hidden');
      
      // Update URL
      const newUrl = `${window.location.pathname}?room=${state.roomId}`;
      window.history.pushState({}, '', newUrl);
      
      // Show invite modal
      setTimeout(() => {
        showInviteModal();
      }, 1000);
      
      // Get user media
      getUserMedia();
      
      // Initialize charts
      initProductivityChart();
      initWeeklyChart();
    }

    function showJoinModal() {
      elements.joinModal.classList.add('active');
    }

    function hideJoinModal() {
      elements.joinModal.classList.remove('active');
    }

    function showInviteModal() {
      elements.roomIdToShare.value = state.roomId;
      elements.roomLinkToShare.value = `${window.location.origin}${window.location.pathname}?room=${state.roomId}`;
      elements.inviteModal.classList.add('active');
    }

    function hideInviteModal() {
      elements.inviteModal.classList.remove('active');
    }

    function copyRoomId() {
      navigator.clipboard.writeText(state.roomId);
      showNotification('Room ID copied!');
    }

    function copyRoomLink() {
      navigator.clipboard.writeText(`${window.location.origin}${window.location.pathname}?room=${state.roomId}`);
      showNotification('Room link copied!');
    }

    function showNotification(message) {
      elements.notification.textContent = message;
      elements.notification.classList.add('show');
      
      setTimeout(() => {
        elements.notification.classList.remove('show');
      }, 3000);
    }

    function joinRoom() {
      const roomId = elements.roomIdInput.value.trim();
      if (!roomId) return;
      
      // Save user data
      state.user.name = elements.userName.value.trim() || 'Anonymous';
      state.user.focusGoal = elements.focusGoal.value.trim();
      state.user.skills = elements.userSkills.value.split(',').map(s => s.trim());
      state.user.workType = elements.workType.value;
      
      localStorage.setItem('userName', state.user.name);
      localStorage.setItem('focusGoal', state.user.focusGoal);
      localStorage.setItem('skills', state.user.skills.join(','));
      localStorage.setItem('workType', state.user.workType);
      localStorage.setItem('peerId', state.user.id);
      
      state.roomId = roomId;
      
      // Initialize PeerJS
      initializePeer();
      
      // Update UI
      updateUserDisplay();
      elements.lobby.classList.add('hidden');
      elements.room.classList.remove('hidden');
      hideJoinModal();
      
      // Update URL
      const newUrl = `${window.location.pathname}?room=${state.roomId}`;
      window.history.pushState({}, '', newUrl);
      
      // Get user media
      getUserMedia();
      
      // Initialize charts
      initProductivityChart();
      initWeeklyChart();
    }

    function initializePeer() {
      peer = new Peer(state.user.id);
      
      peer.on('open', () => {
        console.log('Peer connected with ID:', state.user.id);
        
        // Check if we should connect to a host
        if (state.roomId && !state.roomId.startsWith('room-')) {
          const hostId = state.roomId.replace('room-', 'user-');
          connectToPeer(hostId);
        }
      });
      
      peer.on('connection', (conn) => {
        conn.on('data', handleData);
        connections.push(conn);
        
        // Send user info to the new connection
        conn.send({
          type: 'user-joined',
          userId: state.user.id,
          userName: state.user.name
        });
      });
      
      peer.on('call', (call) => {
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
          .then(stream => {
            call.answer(stream);
            elements.userVideo.srcObject = stream;
            
            call.on('stream', (remoteStream) => {
              addVideoStream(call.peer, remoteStream);
            });
          })
          .catch(err => {
            console.error('Failed to get media:', err);
            showNotification('Could not access camera/microphone');
          });
      });
      
      peer.on('error', (err) => {
        console.error('PeerJS error:', err);
        showNotification('Connection error. Please try again.');
      });
    }

    function getUserMedia() {
      navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(stream => {
          elements.userVideo.srcObject = stream;
          
          // If we created the room, we're the host
          if (state.roomId.startsWith('room-')) {
            // No need to connect to anyone
          } else {
            // Try to connect to the room host
            const hostId = state.roomId.replace('room-', 'user-');
            connectToPeer(hostId);
          }
        })
        .catch(err => {
          console.error('Error getting media:', err);
          showNotification('Could not access camera/microphone');
          
          // Still allow joining without media
          if (state.roomId.startsWith('room-')) {
            // No need to connect to anyone
          } else {
            const hostId = state.roomId.replace('room-', 'user-');
            connectToPeer(hostId);
          }
        });
    }

    function connectToPeer(peerId) {
      if (peerId === state.user.id) return; // Don't connect to ourselves
      
      const conn = peer.connect(peerId);
      
      conn.on('open', () => {
        connections.push(conn);
        conn.on('data', handleData);
        
        // Send user info
        conn.send({
          type: 'user-joined',
          userId: state.user.id,
          userName: state.user.name
        });
        
        // Call the peer for video if we have media
        if (elements.userVideo.srcObject) {
          const call = peer.call(peerId, elements.userVideo.srcObject);
          
          call.on('stream', (remoteStream) => {
            addVideoStream(peerId, remoteStream);
          });
        }
      });
      
      conn.on('error', (err) => {
        console.error('Connection error:', err);
        showNotification('Failed to connect to peer');
      });
    }

    function handleData(data) {
      switch (data.type) {
        case 'message':
          addMessage(data.sender, data.text, data.timestamp);
          break;
        case 'timer':
          setTimer(data.timeLeft, data.isRunning);
          break;
        case 'user-joined':
          addParticipant(data.userId, data.userName);
          
          // If we're the host and have media, call the new peer
          if (state.roomId.startsWith('room-') && elements.userVideo.srcObject) {
            setTimeout(() => {
              const call = peer.call(data.userId, elements.userVideo.srcObject);
              
              call.on('stream', (remoteStream) => {
                addVideoStream(data.userId, remoteStream);
              });
            }, 1000);
          }
          break;
      }
    }

    function addVideoStream(peerId, stream) {
      // Check if video already exists
      if (document.getElementById(peerId)) return;
      
      const video = document.createElement('video');
      video.id = peerId;
      video.srcObject = stream;
      video.autoplay = true;
      video.playsInline = true;
      video.style.width = '100%';
      video.style.borderRadius = '8px';
      video.style.aspectRatio = '16/9';
      
      elements.videoGrid.appendChild(video);
      
      // Add to participants list if not already there
      if (!document.getElementById(`participant-${peerId}`)) {
        addParticipant(peerId, `Peer ${peerId.slice(0, 4)}`);
      }
    }

    function addParticipant(userId, userName) {
      // Check if already added
      if (document.getElementById(`participant-${userId}`)) return;
      
      const participant = document.createElement('div');
      participant.className = 'user-card';
      participant.id = `participant-${userId}`;
      
      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.textContent = userName.charAt(0).toUpperCase();
      
      const info = document.createElement('div');
      info.className = 'user-info';
      
      const name = document.createElement('div');
      name.className = 'user-name';
      name.textContent = userName;
      
      const status = document.createElement('div');
      status.className = 'user-status';
      status.textContent = 'Online';
      
      info.appendChild(name);
      info.appendChild(status);
      participant.appendChild(avatar);
      participant.appendChild(info);
      elements.participantsList.appendChild(participant);
      
      updateParticipantCount();
    }

    function updateParticipantCount() {
      const count = document.querySelectorAll('.user-card').length;
      elements.participantCount.textContent = count;
    }

    function updateUserDisplay() {
      elements.displayUserName.textContent = state.user.name;
      elements.displayRoomId.textContent = state.roomId;
      elements.userAvatar.textContent = state.user.name.charAt(0).toUpperCase();
    }

    function setTimer(seconds, shouldRun = false) {
      clearInterval(state.timer.interval);
      
      state.timer.timeLeft = seconds;
      state.timer.initialTime = seconds;
      updateTimerDisplay();
      
      if (shouldRun) {
        startTimer();
      } else {
        state.timer.isRunning = false;
        elements.timerToggle.textContent = 'Start Timer';
      }
    }

    function startTimer() {
      clearInterval(state.timer.interval);
      
      state.timer.isRunning = true;
      elements.timerToggle.textContent = 'Pause Timer';
      
      state.timer.interval = setInterval(() => {
        state.timer.timeLeft--;
        updateTimerDisplay();
        
        if (state.timer.timeLeft <= 0) {
          clearInterval(state.timer.interval);
          state.timer.isRunning = false;
          elements.timerToggle.textContent = 'Start Timer';
          playTimerSound();
          
          // Track productive session
          const minutes = Math.ceil((state.timer.initialTime - state.timer.timeLeft) / 60);
          state.productivity.focusedTime += minutes;
          state.productivity.sessions.push({
            date: new Date().toISOString(),
            minutes: minutes,
            type: 'focused'
          });
          
          // Update streak
          checkStreak();
          
          // Save to localStorage
          localStorage.setItem('focusedTime', state.productivity.focusedTime);
          localStorage.setItem('sessions', JSON.stringify(state.productivity.sessions));
          localStorage.setItem('streak', state.productivity.streak);
          localStorage.setItem('lastSessionDate', state.productivity.lastSessionDate);
          
          // Update UI
          updateProductivityStats();
          updateProductivityChart();
          updateWeeklyChart();
          
          // Show notification
          showNotification(`Great job! You focused for ${minutes} minutes.`);
        }
      }, 1000);
      
      // Broadcast timer state to peers
      broadcastData({
        type: 'timer',
        timeLeft: state.timer.timeLeft,
        isRunning: state.timer.isRunning
      });
    }

    function toggleTimer() {
      if (state.timer.isRunning) {
        clearInterval(state.timer.interval);
        state.timer.isRunning = false;
        elements.timerToggle.textContent = 'Start Timer';
        
        // Track distracted time
        const distractedMinutes = Math.ceil((state.timer.initialTime - state.timer.timeLeft) / 60);
        if (distractedMinutes > 0) {
          state.productivity.sessions.push({
            date: new Date().toISOString(),
            minutes: distractedMinutes,
            type: 'distracted'
          });
          updateProductivityChart();
          updateWeeklyChart();
        }
      } else {
        startTimer();
      }
    }

    function updateTimerDisplay() {
      const minutes = Math.floor(state.timer.timeLeft / 60);
      const seconds = state.timer.timeLeft % 60;
      elements.timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
    }

    function playTimerSound() {
      elements.timerSound.src = 'https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3';
      elements.timerSound.play();
    }

    function sendMessage() {
      const message = elements.chatInput.value.trim();
      if (!message) return;
      
      const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      addMessage(state.user.name, message, timestamp);
      
      // Broadcast to peers
      broadcastData({
        type: 'message',
        sender: state.user.name,
        text: message,
        timestamp: timestamp
      });
      
      elements.chatInput.value = '';
    }

    function addMessage(sender, text, timestamp) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message';
      
      messageDiv.innerHTML = `
        <div class="message-sender">${sender}</div>
        <div class="message-text">${text}</div>
        <div class="message-time">${timestamp}</div>
      `;
      
      elements.chatMessages.appendChild(messageDiv);
      elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
    }

    function changeAmbientSound() {
      state.ambientSound = elements.ambientSound.value;
      
      if (state.ambientSound) {
        const sounds = {
          cafe: 'https://assets.mixkit.co/sfx/preview/mixkit-busy-coffee-shop-759.mp3',
          rain: 'https://assets.mixkit.co/sfx/preview/mixkit-rain-ambient-1141.mp3',
          fireplace: 'https://assets.mixkit.co/sfx/preview/mixkit-crackling-fireplace-1190.mp3',
          forest: 'https://assets.mixkit.co/sfx/preview/mixkit-forest-ambience-1681.mp3',
          waves: 'https://assets.mixkit.co/sfx/preview/mixkit-waves-on-the-beach-2381.mp3'
        };
        
        elements.ambientAudio.src = sounds[state.ambientSound];
        elements.ambientAudio.play().catch(e => console.log('Audio play failed:', e));
      } else {
        elements.ambientAudio.pause();
      }
    }

    function broadcastData(data) {
      connections.forEach(conn => {
        try {
          conn.send(data);
        } catch (err) {
          console.error('Error sending data:', err);
        }
      });
    }

    function leaveRoom() {
      // Stop all media streams
      if (elements.userVideo.srcObject) {
        elements.userVideo.srcObject.getTracks().forEach(track => track.stop());
      }
      
      // Clear timer
      clearInterval(state.timer.interval);
      
      // Close all peer connections
      connections.forEach(conn => conn.close());
      if (peer) peer.destroy();
      
      // Remove all peer videos
      document.querySelectorAll('video:not(#userVideo)').forEach(video => video.remove());
      
      // Clear participants list except self
      document.querySelectorAll('.user-card:not(:first-child)').forEach(el => el.remove());
      updateParticipantCount();
      
      // Reset state
      state.peers = [];
      state.messages = [];
      state.timer = {
        timeLeft: 1500,
        isRunning: false,
        interval: null,
        initialTime: 1500
      };
      state.ambientSound = '';
      elements.ambientSound.value = '';
      elements.ambientAudio.pause();
      
      // Update UI
      elements.lobby.classList.remove('hidden');
      elements.room.classList.add('hidden');
      elements.chatMessages.innerHTML = `
        <div class="message">
          <div class="message-sender">FocusHub</div>
          <div class="message-text">Welcome to your coworking space! Start collaborating with your peers.</div>
          <div class="message-time">Just now</div>
        </div>
      `;
      elements.timerDisplay.textContent = '25:00';
      elements.timerToggle.textContent = 'Start Timer';
      
      // Reset URL
      window.history.pushState({}, '', window.location.pathname);
    }

    function checkStreak() {
      const today = new Date().toDateString();
      const lastSessionDate = state.productivity.lastSessionDate;
      
      if (!lastSessionDate) {
        // First session
        state.productivity.streak = 1;
      } else {
        const lastDate = new Date(lastSessionDate);
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        
        if (lastDate.toDateString() === yesterday.toDateString()) {
          // Continuing streak
          state.productivity.streak++;
        } else if (lastDate.toDateString() !== today) {
          // Broken streak
          state.productivity.streak = 1;
        }
      }
      
      state.productivity.lastSessionDate = today;
      updateProductivityStats();
    }

    function updateProductivityStats() {
      elements.focusedTime.textContent = state.productivity.focusedTime;
      elements.sessionsCount.textContent = state.productivity.sessions.length;
      elements.streakDays.textContent = state.productivity.streak;
    }

    function initProductivityChart() {
      const ctx = elements.productivityChart.getContext('2d');
      
      // Calculate focused vs distracted time
      const focused = state.productivity.sessions
        .filter(s => s.type === 'focused')
        .reduce((sum, session) => sum + session.minutes, 0);
      
      const distracted = state.productivity.sessions
        .filter(s => s.type === 'distracted')
        .reduce((sum, session) => sum + session.minutes, 0);
      
      productivityChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Focused', 'Distracted'],
          datasets: [{
            data: [focused, distracted],
            backgroundColor: ['#4361ee', '#f72585'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '70%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                usePointStyle: true,
                padding: 20
              }
            }
          }
        }
      });
    }

    function updateProductivityChart() {
      const focused = state.productivity.sessions
        .filter(s => s.type === 'focused')
        .reduce((sum, session) => sum + session.minutes, 0);
      
      const distracted = state.productivity.sessions
        .filter(s => s.type === 'distracted')
        .reduce((sum, session) => sum + session.minutes, 0);
      
      productivityChart.data.datasets[0].data = [focused, distracted];
      productivityChart.update();
    }

    function initWeeklyChart() {
      const ctx = elements.weeklyChart.getContext('2d');
      
      // Get last 7 days
      const days = [];
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        days.push(date.toLocaleDateString([], { weekday: 'short' }));
      }
      
      // Get data for each day
      const focusedData = Array(7).fill(0);
      const distractedData = Array(7).fill(0);
      
      state.productivity.sessions.forEach(session => {
        const sessionDate = new Date(session.date);
        const today = new Date();
        const diffTime = today - sessionDate;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays <= 6) {
          const index = 6 - diffDays;
          if (session.type === 'focused') {
            focusedData[index] += session.minutes;
          } else {
            distractedData[index] += session.minutes;
          }
        }
      });
      
      weeklyChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: days,
          datasets: [
            {
              label: 'Focused',
              data: focusedData,
              backgroundColor: '#4361ee'
            },
            {
              label: 'Distracted',
              data: distractedData,
              backgroundColor: '#f72585'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              stacked: true,
              grid: {
                display: false
              }
            },
            y: {
              stacked: true,
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          },
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                usePointStyle: true,
                padding: 20
              }
            }
          }
        }
      });
    }

    function updateWeeklyChart() {
      // Get last 7 days
      const days = [];
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        days.push(date.toLocaleDateString([], { weekday: 'short' }));
      }
      
      // Get data for each day
      const focusedData = Array(7).fill(0);
      const distractedData = Array(7).fill(0);
      
      state.productivity.sessions.forEach(session => {
        const sessionDate = new Date(session.date);
        const today = new Date();
        const diffTime = today - sessionDate;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays <= 6) {
          const index = 6 - diffDays;
          if (session.type === 'focused') {
            focusedData[index] += session.minutes;
          } else {
            distractedData[index] += session.minutes;
          }
        }
      });
      
      weeklyChart.data.labels = days;
      weeklyChart.data.datasets[0].data = focusedData;
      weeklyChart.data.datasets[1].data = distractedData;
      weeklyChart.update();
    }

    // Initialize the app when the page loads
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
